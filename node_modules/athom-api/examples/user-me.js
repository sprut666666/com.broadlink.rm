"use strict";

var express 	= require('express');
var Api 		= require('..');

var app 		= express();
var config 		= require('./config.json');

var api = new Api({
	client_id		: config.client_id,
	client_secret	: config.client_secret,
	callback_url	: 'http://localhost:1337/callback',
	debug			: true
})

app
	.get('/', function( req, res ){
	
		var auth_url = api.getAuthorizationUrl();
		console.log('got auth url:', auth_url)
		
		res.redirect(auth_url);
		
	})
	.get('/callback', function( req, res ){
		
		console.log('got code:', req.query.code)
		
		var token = api.getAuthorizationToken( req.query.code, function( err, result ){
			
			console.log('got token:', result);
			req.session.user = result;
			
			res.redirect('/user/me');
		});
		
	})
	.get('/user/me', function( req, res ){						
		api.get('/user/me', function(err, result){
			if( err ) return res.send(err.message || err.toString());
			res.json(result);
		})		
	})
	.listen(1337);

console.log('example server running on port 1337');

// get client token
api.getClientToken(function(err, token){
	
	console.log('getClientToken', token)
	
	setInterval(function(){
		api.get('/user/me/', function( err, result, statusCode ){
			console.log('GET', '/user/me/', statusCode)
			if( statusCode != 200 ) console.log(err, result)
		})	
	}, 1000);
	
})